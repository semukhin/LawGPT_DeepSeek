import re
import os
import sys
import json
import asyncio
import aiohttp
import logging
import re  # –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç –¥–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π
from typing import Dict, Optional, Any, List
from pathlib import Path
from datetime import datetime
from app.handlers.user_doc_request import extract_text_from_any_document
from app.handlers.deepresearch_audit import audit_deepresearch, deepresearch_audit
from app.services.deepseek_service import DeepSeekService
from app.models import PromptLog  # –ò–º–ø–æ—Ä—Ç –º–æ–¥–µ–ª–∏ –¥–ª—è –ª–æ–≥–æ–≤ –ø—Ä–æ–º–ø—Ç–æ–≤
from sqlalchemy.orm import Session
from app import models

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ config.py
from app.config import DEEPSEEK_API_KEY, DEEPSEEK_MODEL

# üìÇ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—É—Ç–∏ –∫ third_party –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ shandu
BASE_DIR = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
THIRD_PARTY_DIR = os.path.join(BASE_DIR, "third_party")
if THIRD_PARTY_DIR not in sys.path:
    sys.path.insert(0, THIRD_PARTY_DIR)

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è —Ä–∞–∑–º–µ—Ä–∞
MAX_INPUT_QUERY_SIZE = 12000  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª—è –≤—Ö–æ–¥–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
MAX_ADDITIONAL_CONTEXT_SIZE = 8000  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç


# –£–ª—É—á—à–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ª–æ–≥–≥–µ—Ä–∞ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
logging.basicConfig(
    level=logging.INFO, 
    format="%(asctime)s - %(levelname)s - [%(filename)s:%(lineno)d] - %(message)s"
)

def truncate_text_intelligently(text: str, max_length: int) -> str:
    """
    –£–º–Ω–∞—è –æ–±—Ä–µ–∑–∫–∞ —Ç–µ–∫—Å—Ç–∞, —Å–æ—Ö—Ä–∞–Ω—è—è –Ω–∞–∏–±–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —á–∞—Å—Ç–∏.
    
    Args:
        text: –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
        max_length: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–æ–ø—É—Å—Ç–∏–º–∞—è –¥–ª–∏–Ω–∞
        
    Returns:
        –û–±—Ä–µ–∑–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç max_length
    """
    if len(text) <= max_length:
        return text
        
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞
    start_buffer = int(max_length * 0.5)  # 50% –¥–ª—è –Ω–∞—á–∞–ª–∞
    end_buffer = int(max_length * 0.3)  # 30% –¥–ª—è –∫–æ–Ω—Ü–∞
    middle_buffer = max_length - start_buffer - end_buffer - 20  # 20 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è "..."
    
    # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –∞–±–∑–∞—Ü—ã –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
    paragraphs = text.split('\n\n')
    
    # –ï—Å–ª–∏ –≤—Å–µ–≥–æ –æ–¥–∏–Ω –∞–±–∑–∞—Ü, –ø—Ä–æ—Å—Ç–æ –æ–±—Ä–µ–∑–∞–µ–º –µ–≥–æ
    if len(paragraphs) <= 1:
        return text[:start_buffer] + "..." + text[-end_buffer:]
    
    # –°–æ–±–∏—Ä–∞–µ–º –Ω–∞—á–∞–ª–æ —Ç–µ–∫—Å—Ç–∞, —Å–æ—Ö—Ä–∞–Ω—è—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –∞–±–∑–∞—Ü–µ–≤
    start_text = ""
    for p in paragraphs:
        if len(start_text) + len(p) + 2 <= start_buffer:  # +2 –¥–ª—è \n\n
            start_text += p + "\n\n"
        else:
            # –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –∞–±–∑–∞—Ü –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é, –±–µ—Ä–µ–º –µ–≥–æ —á–∞—Å—Ç—å
            if len(start_text) < start_buffer:
                remaining = start_buffer - len(start_text)
                if remaining > 20:  # –ï—Å–ª–∏ –æ—Å—Ç–∞–ª–æ—Å—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞
                    start_text += p[:remaining] + "..."
            break
    
    # –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω–µ—Ü —Ç–µ–∫—Å—Ç–∞, —Å–æ—Ö—Ä–∞–Ω—è—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –∞–±–∑–∞—Ü–µ–≤
    end_text = ""
    for p in reversed(paragraphs):
        if len(end_text) + len(p) + 2 <= end_buffer:  # +2 –¥–ª—è \n\n
            end_text = p + "\n\n" + end_text
        else:
            # –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –∞–±–∑–∞—Ü –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é, –±–µ—Ä–µ–º –µ–≥–æ —á–∞—Å—Ç—å
            if len(end_text) < end_buffer:
                remaining = end_buffer - len(end_text)
                if remaining > 20:  # –ï—Å–ª–∏ –æ—Å—Ç–∞–ª–æ—Å—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞
                    end_text = "..." + p[-remaining:] + "\n\n" + end_text
            break
    
    # –ï—Å–ª–∏ —É –Ω–∞—Å –æ—Å—Ç–∞–ª–æ—Å—å –º–µ—Å—Ç–æ –¥–ª—è —Å–µ—Ä–µ–¥–∏–Ω—ã, –¥–æ–±–∞–≤–ª—è–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–±–∑–∞—Ü–µ–≤ –∏–∑ —Å–µ—Ä–µ–¥–∏–Ω—ã
    if middle_buffer > 100:  # –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–ª—è —Å–µ—Ä–µ–¥–∏–Ω—ã –µ—Å—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞
        middle_start_index = len(start_text)
        middle_end_index = len(text) - len(end_text)
        
        # –ù–∞—Ö–æ–¥–∏–º –∞–±–∑–∞—Ü—ã –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ
        middle_text = text[middle_start_index:middle_end_index]
        middle_paragraphs = middle_text.split('\n\n')
        
        # –í—ã–±–∏—Ä–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–±–∑–∞—Ü–µ–≤ –∏–∑ —Å–µ—Ä–µ–¥–∏–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, 2-3)
        selected_middle = ""
        middle_position = len(middle_paragraphs) // 2  # –¶–µ–Ω—Ç—Ä —Å–ø–∏—Å–∫–∞ –∞–±–∑–∞—Ü–µ–≤
        
        # –ü—ã—Ç–∞–µ–º—Å—è –¥–æ–±–∞–≤–∏—Ç—å –∞–±–∑–∞—Ü—ã –∏–∑ —Å–µ—Ä–µ–¥–∏–Ω—ã
        for i in range(max(0, middle_position - 1), min(len(middle_paragraphs), middle_position + 2)):
            if len(selected_middle) + len(middle_paragraphs[i]) + 2 <= middle_buffer:
                selected_middle += middle_paragraphs[i] + "\n\n"
            else:
                break
        
        return start_text + "\n...\n\n" + selected_middle + "\n...\n\n" + end_text
    
    # –ï—Å–ª–∏ –¥–ª—è —Å–µ—Ä–µ–¥–∏–Ω—ã –Ω–µ —Ö–≤–∞—Ç–∏–ª–æ –º–µ—Å—Ç–∞
    return start_text + "\n...\n\n" + end_text

def highlight_court_numbers(query: str) -> str:
    """
    –í—ã–¥–µ–ª—è–µ—Ç –Ω–æ–º–µ—Ä–∞ —Å—É–¥–µ–±–Ω—ã—Ö –¥–µ–ª –≤ –∑–∞–ø—Ä–æ—Å–µ —Å —É—á–µ—Ç–æ–º —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö —Å—É–¥–æ–≤.
    """
    """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ –≤—ã–¥–µ–ª–µ–Ω–∏—è –Ω–æ–º–µ—Ä–æ–≤ —Å—É–¥–µ–±–Ω—ã—Ö –¥–µ–ª"""
    return query


def validate_court_numbers(response: str, original_query: str) -> str:
    """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–æ–≤ —Å—É–¥–µ–±–Ω—ã—Ö –¥–µ–ª"""
    return response

def ensure_valid_court_numbers(answer: str, original_query: str) -> str:
    """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–º–µ—Ä–æ–≤ –¥–µ–ª"""
    return answer

class ResearchResult:
    """–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è."""
    
    def __init__(self, query: str, analysis: str, timestamp: str, error: Optional[str] = None):
        self.query = query
        self.analysis = analysis
        self.timestamp = timestamp
        self.error = error
    
    def to_dict(self) -> Dict[str, Any]:
        """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Å–ª–æ–≤–∞—Ä—å."""
        return {
            "query": self.query,
            "analysis": self.analysis,
            "timestamp": self.timestamp,
            "error": self.error
        }
    
    def save_to_file(self, filepath: str) -> None:
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ñ–∞–π–ª."""
        with open(filepath, 'w', encoding='utf-8') as f:
            json.dump(self.to_dict(), f, ensure_ascii=False, indent=2)

class DeepResearchService:
    """
    –°–µ—Ä–≤–∏—Å –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.
    –ö–æ–º–±–∏–Ω–∏—Ä—É–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ Shandu –∏ DeepSeek API –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
    """
    
    def __init__(self, output_dir: Optional[str] = None):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–µ—Ä–≤–∏—Å —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.
        
        Args:
            output_dir: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π.
        """
        self.output_dir = output_dir or "research_results"
        os.makedirs(self.output_dir, exist_ok=True)
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º DeepSeek —Å–µ—Ä–≤–∏—Å
        self.deepseek_service = DeepSeekService(
            api_key=DEEPSEEK_API_KEY,
            model=DEEPSEEK_MODEL,
            temperature=1.2, 
            max_tokens=8192,
            timeout=180
        )
            
        logging.info(f"DeepResearchService –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: {self.output_dir}")
        
        # –°—á–µ—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        self.usage_counter = 0

    def filter_suspicious_court_numbers(self, text: str) -> str:
        """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ —Å—É–¥–µ–±–Ω—ã—Ö –¥–µ–ª"""
        return text
        
        
    def is_general_query(self, query: str) -> bool:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–∞–ø—Ä–æ—Å –æ–±—â–∏–º (–Ω–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–º).
        
        Args:
            query: –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞
            
        Returns:
            True, –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –æ–±—â–∏–π, False, –µ—Å–ª–∏ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π
        """
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∑–∞–ø—Ä–æ—Å –≤ –Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        query_lower = query.lower().strip()
        
        # –°–ø–∏—Å–æ–∫ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤ (–ø—Ä–∏–≤–µ–¥–µ–Ω–Ω—ã–π –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É)
        legal_terms = [
            "–∑–∞–∫–æ–Ω", "–∫–æ–¥–µ–∫—Å", "—Å—Ç–∞—Ç—å—è", "–¥–æ–≥–æ–≤–æ—Ä", "–∏—Å–∫", "—Å—É–¥", "–ø—Ä–∞–≤–æ", "—é—Ä–∏—Å—Ç", 
            "–Ω–æ—Ä–º–∞", "—Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω", "–∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤", "–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç", "—à—Ç—Ä–∞—Ñ", 
            "–æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤", "–ø—Ä–µ—Ç–µ–Ω–∑–∏", "–≤–∏–Ω–∞", "—É—Å—Ç–∞–≤", "—Å–æ–≥–ª–∞—à–µ–Ω–∏–µ", "–≥–∫", "–≥–ø–∫", "–∫–∞—Å", 
            "–Ω–∞–ª–æ–≥", "—é—Ä–ª–∏—Ü–æ", "—Ñ–∏–∑–ª–∏—Ü", "–≥—Ä–∞–∂–¥–∞–Ω–∏–Ω", "–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏", "—Ñ–≥—É–ø", "–ø—Ä–∞–≤–µ",
            "–∞—Ä–µ–Ω–¥–∞", "–∑–∞–ª–æ–≥", "–Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å", "—Å–¥–µ–ª–∫–∞", "–Ω–∞—Å–ª–µ–¥—Å—Ç–≤–æ", "–ø—Ä–∞–≤–æ–º–æ—á–∏—è",
            "–∞–∫—Ü–∏–æ–Ω–µ—Ä", "–¥–∏–≤–∏–¥–µ–Ω–¥—ã", "–ø—Ä–∞–≤–æ–Ω–∞—Ä—É—à–µ–Ω–∏–µ", "–ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏–µ", "–∏–º—É—â–µ—Å—Ç–≤–æ",
            "–æ—Ñ–µ—Ä—Ç–∞", "–∞–∫—Ü–µ–ø—Ç", "–Ω–æ—Ç–∞—Ä–∏—É—Å", "–¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å", "–ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ",
            "–±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–æ", "–ª–∏–∫–≤–∏–¥–∞—Ü–∏—è", "—Ä–µ–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è", "–≤—ã–ø–∏—Å–∫–∞", "–µ–≥—Ä—é–ª", "–æ–æ–æ",
            "–∫–∞–ø–∏—Ç–∞–ª", "—É—á—Ä–µ–¥–∏—Ç–µ–ª—å", "–ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å", "–∏–ø", "–∞–æ", "—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü", "–ª–∏—Ü–µ–Ω–∑",
            "—Å–∞–Ω–∫—Ü", "–∞—Ä–±–∏—Ç—Ä–∞–∂", "–∏—Å—Ç–µ—Ü", "–æ—Ç–≤–µ—Ç—á–∏–∫", "–∞–ø–µ–ª–ª—è—Ü", "–∫–∞—Å—Å–∞—Ü", "–∏–º—É—â–µ—Å—Ç–≤", "—Å–≤–æ"
        ]
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã (–í–°–ï–ì–î–ê –ø–µ—Ä–µ–¥ –¥—Ä—É–≥–∏–º–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏)
        for term in legal_terms:
            if term in query_lower:
                # –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π —Ç–µ—Ä–º–∏–Ω, —Ç–æ —ç—Ç–æ –Ω–µ –æ–±—â–∏–π –∑–∞–ø—Ä–æ—Å
                return False
        
        # –°–ø–∏—Å–æ–∫ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –æ–±—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        general_patterns = [
            # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
            "–ø—Ä–∏–≤–µ—Ç", "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π", "–¥–æ–±—Ä—ã–π –¥–µ–Ω—å", "–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ", "–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä", "–∑–¥–æ—Ä–æ–≤–æ", "—Ö–∞–π",
            "–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é", "—Å–∞–ª—é—Ç", "–¥–æ–±—Ä–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏", "—Ö–µ–ª–ª–æ—É", "–∫—É", "—Ö–æ–ª–∞", "–π–æ—É", "–≤–µ—á–µ—Ä –¥–æ–±—Ä—ã–π",
            
            # –û —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–µ
            "–∫–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç", "–∫—Ç–æ —Ç—ã", "—á—Ç–æ —Ç—ã —É–º–µ–µ—à—å", "—á—Ç–æ —Ç—ã –º–æ–∂–µ—à—å", "—á–µ–º —Ç—ã –∑–∞–Ω–∏–º–∞–µ—à—å—Å—è",
            "—Ä–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ", "–∫–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—à—å—Å—è", "–∫—Ç–æ —Ç–µ–±—è —Å–æ–∑–¥–∞–ª", "–∫—Ç–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–ª",
            "—Ç–≤–æ–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏", "—Ç–≤–æ—è –≤–µ—Ä—Å–∏—è", "—Ç–≤–æ–∏ —Ñ—É–Ω–∫—Ü–∏–∏", "—Ç—ã —Ä–æ–±–æ—Ç", "—Ç—ã –±–æ—Ç", 
            "–∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç", "–Ω–µ–π—Ä–æ–Ω–Ω–∞—è —Å–µ—Ç—å", "–±–æ–ª—å—à–∞—è —è–∑—ã–∫–æ–≤–∞—è –º–æ–¥–µ–ª—å", 
            "–∫–æ–≥–¥–∞ —Ç–µ–±—è —Å–æ–∑–¥–∞–ª–∏", "–≥–¥–µ —Ç—ã –Ω–∞—Ö–æ–¥–∏—à—å—Å—è", "—Ç–≤–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫",
            
            # –í–æ–ø—Ä–æ—Å—ã –æ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–∏
            "–∫–∞–∫ –¥–µ–ª–∞", "–∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ", "–∫–∞–∫ –∂–∏–∑–Ω—å", "–∫–∞–∫ —Ç—ã", "–≤—Å–µ —Ö–æ—Ä–æ—à–æ", 
            "—á—Ç–æ –Ω–æ–≤–æ–≥–æ", "–∫–∞–∫ –ø–æ–∂–∏–≤–∞–µ—à—å", "–∫–∞–∫ —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å", "–∫–∞–∫ —Ç–≤–æ–∏ –¥–µ–ª–∞",
            
            # –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏
            "—Å–ø–∞—Å–∏–±–æ", "–±–ª–∞–≥–æ–¥–∞—Ä—é", "—Å–ø—Å", "–ø–∞—Å–∏–±", "—Å–µ–Ω–∫—Å", "–±–ª–∞–≥–æ–¥–∞—Ä–µ–Ω", "–±–ª–∞–≥–æ–¥–∞—Ä–Ω–∞", 
            "–º–µ—Ä—Å–∏", "–ø—Ä–∏–∑–Ω–∞—Ç–µ–ª–µ–Ω", "–±–æ–ª—å—à–æ–µ —Å–ø–∞—Å–∏–±–æ", "–æ—Ç –¥—É—à–∏", "—Ü–µ–Ω—é", "—Ä–µ—Å–ø–µ–∫—Ç",
            
            # –§—Ä–∞–∑—ã –ø—Ä–æ—â–∞–Ω–∏—è
            "–ø–æ–∫–∞", "–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è", "—É–≤–∏–¥–∏–º—Å—è", "–≤—Å–µ–≥–æ –¥–æ–±—Ä–æ–≥–æ", "–¥–æ –≤—Å—Ç—Ä–µ—á–∏", "–±—ã–≤–∞–π",
            "—É–¥–∞—á–∏", "–ø—Ä–æ—â–∞–π", "–¥–æ —Å–∫–æ—Ä–æ–≥–æ", "–ø–æ–∫–µ–¥–∞", "–±—É–¥—å –∑–¥–æ—Ä–æ–≤", "–ø–æ–∫–µ–¥–æ–≤–∞", "—á–∞–æ",
            
            # –ö–æ–º–ø–ª–∏–º–µ–Ω—Ç—ã –∏ –æ—Ü–µ–Ω–∫–∏
            "–º–æ–ª–æ–¥–µ—Ü", "–æ—Ç–ª–∏—á–Ω–æ", "—Ö–æ—Ä–æ—à–æ", "—Å—É–ø–µ—Ä", "–∫–ª–∞—Å—Å", "–∫—Ä—É—Ç–æ", "–Ω–µ–ø–ª–æ—Ö–æ", "–ø—Ä–µ–∫—Ä–∞—Å–Ω–æ", 
            "–∑–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ", "–ø—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω–æ", "–±–ª–µ—Å—Ç—è—â–µ", "–≤–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ", "–ø–æ—Ç—Ä—è—Å–∞—é—â–µ", "—É–º–Ω–∏—Ü–∞", 
            "—à–∏–∫–∞—Ä–Ω–æ", "–±—Ä–∞–≤–æ", "–≤–ø–µ—á–∞—Ç–ª—è–µ—Ç", "–æ–≥–æ–Ω—å", "–±–æ–º–±–∞",
            
            # –ò–∑–≤–∏–Ω–µ–Ω–∏—è –∏ —Å–æ–∂–∞–ª–µ–Ω–∏—è
            "–∏–∑–≤–∏–Ω–∏", "–ø—Ä–æ—Å—Ç–∏", "—Å–æ—Ä—Ä–∏", "–≤–∏–Ω–æ–≤–∞—Ç", "–ø—Ä–æ—à—É –ø—Ä–æ—â–µ–Ω–∏—è", "–º–Ω–µ –∂–∞–ª—å", "—Å–æ–∂–∞–ª–µ—é", 
            "–Ω–µ —Ö–æ—Ç–µ–ª", "–º–æ—è –æ—à–∏–±–∫–∞", "–º–æ–π –∫–æ—Å—è–∫", "–Ω–µ –æ–±–∏–∂–∞–π—Å—è", "–∏–∑–≤–∏–Ω—è—é—Å—å",
            
            # –°–æ–≥–ª–∞—Å–∏–µ/–Ω–µ—Å–æ–≥–ª–∞—Å–∏–µ
            "—Å–æ–≥–ª–∞—Å–µ–Ω", "–Ω–µ —Å–æ–≥–ª–∞—Å–µ–Ω", "—Ç–∞–∫ —Ç–æ—á–Ω–æ", "–æ—Ç–ª–∏—á–Ω–æ", "–Ω–µ–≤–µ—Ä–Ω–æ", "–ø—Ä–∞–≤–∏–ª—å–Ω–æ", 
            "–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ", "–≤–µ—Ä–Ω–æ", "—Å–æ–≥–ª–∞—à—É—Å—å", "–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é", "–∫–∞—Ç–µ–≥–æ—Ä–∏—á–µ—Å–∫–∏ –Ω–µ—Ç",
            
            # –í–æ–ø—Ä–æ—Å—ã –æ –º–æ–¥–µ–ª–∏
            "–∫–∞–∫—É—é –Ω–µ–π—Ä–æ—Å–µ—Ç—å", "–∫–∞–∫–æ–π –Ω–µ–π—Ä–æ–Ω–Ω–æ–π", "–∫–∞–∫–æ–π llm", "–∫–∞–∫–∞—è –º–æ–¥–µ–ª—å", "–Ω–∞ —á–µ–º —Ä–∞–±–æ—Ç–∞–µ—à—å",
            "–Ω–∞ –∫–∞–∫–æ–π —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏", "–Ω–∞ –∫–∞–∫–æ–π –æ—Å–Ω–æ–≤–µ", "–Ω–∞ –∫–∞–∫–æ–º —è–∑—ã–∫–µ", "deepseek", "claude", "gpt",
            "—Ç–æ–∫–µ–Ω—ã", "–∫–æ–Ω—Ç–µ–∫—Å—Ç", "–æ–±—É—á–µ–Ω–∏–µ", "—è–∑—ã–∫–æ–≤–∞—è –º–æ–¥–µ–ª—å", "–∏–∏", "–∞–∏", "–∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π", "ai",
            "—Å–∫–æ–ª—å–∫–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤", "—Ç–≤–æ—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞", "transformer", "—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä",
            
            # –ö–æ—Ä–æ—Ç–∫–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            "–æ–∫", "—è—Å–Ω–æ", "–ø–æ–Ω—è–ª", "–ø–æ–Ω—è—Ç–Ω–æ", "–¥–∞", "–Ω–µ—Ç", "–∫–æ–Ω–µ—á–Ω–æ", "—Ä–∞–∑—É–º–µ–µ—Ç—Å—è", "–≤–æ–∑–º–æ–∂–Ω–æ",
            "–∏–º–µ–Ω–Ω–æ", "–Ω–∞–≤–µ—Ä–Ω–æ–µ", "–≤–µ—Ä–æ—è—Ç–Ω–æ", "–æ—á–µ–≤–∏–¥–Ω–æ", "–ª–æ–≥–∏—á–Ω–æ", "–±–µ–∑—É—Å–ª–æ–≤–Ω–æ",
            
            # –ü—Ä–æ—Å—å–±—ã –æ –ø–æ–º–æ—â–∏
            "–ø–æ–º–æ–≥–∏", "–ø–æ–¥—Å–∫–∞–∂–∏", "–ø–æ–º–æ—â—å", "–ø–æ–¥–¥–µ—Ä–∂–∫–∞", "–Ω–µ –ø–æ–Ω–∏–º–∞—é", "–∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç",
            "–æ–±—ä—è—Å–Ω–∏", "—Ä–∞–∑—ä—è—Å–Ω–∏", "—É—Ç–æ—á–Ω–∏", "–∫–∞–∫ –º–Ω–µ", "—á—Ç–æ –¥–µ–ª–∞—Ç—å", "–∫–∞–∫ –±—ã—Ç—å",
            
            # –£–∫–∞–∑–∞–Ω–∏—è –Ω–∞ –æ—à–∏–±–∫–∏
            "–æ—à–∏–±–∫–∞", "—Ç—ã –æ—à–∏–±–∞–µ—à—å—Å—è", "—ç—Ç–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ", "–æ—à–∏–±—Å—è", "–Ω–µ —Ç–∞–∫", "–Ω–µ—Ç–æ—á–Ω–æ",
            "–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ", "–Ω–µ–ø—Ä–∞–≤–¥–∞", "–ø—É—Ç–∞–µ—à—å", "–∑–∞–±–ª—É–∂–¥–∞–µ—à—å—Å—è", 
            
            # –ü—Ä–æ—Å—å–±—ã –æ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–∏
            "–ø—Ä–æ–¥–æ–ª–∂–∞–π", "–¥–∞–ª—å—à–µ", "—á—Ç–æ –µ—â–µ", "–∏ —á—Ç–æ", "–µ—â–µ", "—Ä–∞—Å—Å–∫–∞–∂–∏ –±–æ–ª—å—à–µ",
            "–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ", "–¥–∞–ª—å–Ω–µ–π—à–µ–µ", "—Å–ª–µ–¥—É—é—â–µ–µ", "—á—Ç–æ –ø–æ—Ç–æ–º", "–∞ –∑–∞—Ç–µ–º"
        ]

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –∑–∞–ø—Ä–æ—Å –æ–±—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
        for pattern in general_patterns:
            if pattern in query_lower:
                return True

        # –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–π (–º–µ–Ω–µ–µ 4 —Å–ª–æ–≤), —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —ç—Ç–æ –æ–±—â–∏–π –∑–∞–ø—Ä–æ—Å
        if len(query_lower.split()) < 4 and len(query_lower) < 25:
            return True
        
        # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—á–∏—Ç–∞–µ–º –∑–∞–ø—Ä–æ—Å —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–º, –µ—Å–ª–∏ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–æ—Å—å, —á—Ç–æ –æ–Ω –æ–±—â–∏–π
        return False

    @audit_deepresearch
    async def research(self, query: str, additional_context: Optional[List[Dict]] = None, thread_id: Optional[str] = None, message_id: Optional[int] = None, user_id: Optional[int] = None, db: Optional[Session] = None) -> ResearchResult:
        """
        –í—ã–ø–æ–ª–Ω—è–µ—Ç –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º DeepSeek API.
        
        Args:
            query: –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –∏–ª–∏ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            additional_context: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –¥—Ä—É–≥–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
            thread_id: ID —Ç—Ä–µ–¥–∞, –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –≤ —Ä–∞–º–∫–∞—Ö –¥–∏–∞–ª–æ–≥–∞
            message_id: ID —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            db: –°–µ—Å—Å–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
                    
        Returns:
            ResearchResult: –†–µ–∑—É–ª—å—Ç–∞—Ç –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ
        """
        # –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞–º–∏
        MAX_INPUT_QUERY_SIZE = 20000  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞
        MAX_ADDITIONAL_CONTEXT_SIZE = 15000  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        MAX_CHAT_HISTORY_SIZE = 10000  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
        MAX_MESSAGE_SIZE = 2000  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏–∏
        
        self.usage_counter += 1
        logging.info(f"[DeepResearch #{self.usage_counter}] –ù–∞—á–∏–Ω–∞–µ–º –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ. –î–ª–∏–Ω–∞ –∑–∞–ø—Ä–æ—Å–∞: {len(query)} —Å–∏–º–≤–æ–ª–æ–≤")
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤, –µ—Å–ª–∏ query - –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
        if isinstance(query, str) and (query.endswith('.docx') or query.endswith('.pdf')):
            query = self.read_document(query) or query
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞
        if len(query) > MAX_INPUT_QUERY_SIZE:
            logging.warning(f"[DeepResearch #{self.usage_counter}] –ó–∞–ø—Ä–æ—Å —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π ({len(query)} —Å–∏–º–≤–æ–ª–æ–≤). –û–±—Ä–µ–∑–∞–µ–º –¥–æ {MAX_INPUT_QUERY_SIZE} —Å–∏–º–≤–æ–ª–æ–≤.")
            query = truncate_text_intelligently(query, MAX_INPUT_QUERY_SIZE)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è, –µ—Å—Ç—å –ª–∏ –≤ –Ω–µ–º —è–≤–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ
        # –Ω–∞ –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
        if "–ó–ê–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:" in query and "–†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–û–ò–°–ö–ê:" in query:
            # –ó–∞–ø—Ä–æ—Å —É–∂–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω, –∏–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å—Ç—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_query_part = query.split("–ó–ê–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:")[1].split("–†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–û–ò–°–ö–ê")[0].strip()
            is_general = self.is_general_query(user_query_part)
        else:
            is_general = self.is_general_query(query)

        # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π, –µ—Å–ª–∏ –µ—Å—Ç—å thread_id –∏ db
        chat_history = []
        if thread_id and db:
            try:
                from app.models import Message
                # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ —Ç—Ä–µ–¥–∞, —Å–æ—Ä—Ç–∏—Ä—É—è –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è
                messages = db.query(Message).filter(
                    Message.thread_id == thread_id
                ).order_by(Message.created_at.desc()).limit(5).all()
                
                # –ü–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞
                messages.reverse()
                
                # –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                logging.info(f"[DeepResearch #{self.usage_counter}] –ù–∞–π–¥–µ–Ω–æ {len(messages)} –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ç—Ä–µ–¥–µ {thread_id}")
                
                # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –Ω—É–∂–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
                total_history_size = 0
                for msg in messages:
                    content = msg.content
                    # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏
                    if len(content) > MAX_MESSAGE_SIZE:
                        content = content[:MAX_MESSAGE_SIZE] + "...[—Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–µ–∑–∞–Ω–æ]"
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–µ–≤—ã—Å–∏–º –ª–∏ –æ–±—â–∏–π —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏
                    if total_history_size + len(content) > MAX_CHAT_HISTORY_SIZE:
                        break
                    
                    chat_history.append({
                        "role": msg.role,
                        "content": content,
                        "timestamp": msg.created_at.isoformat() if msg.created_at else None
                    })
                    total_history_size += len(content)
                    
            except Exception as e:
                logging.error(f"[DeepResearch #{self.usage_counter}] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞: {str(e)}")
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–∞
        if is_general:
            logging.info(f"[DeepResearch #{self.usage_counter}] –û–±–Ω–∞—Ä—É–∂–µ–Ω –æ–±—â–∏–π (–Ω–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π) –∑–∞–ø—Ä–æ—Å")
            system_prompt = """
            –¢—ã - –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –∏–Ω—Ç–µ–ª–ª–∏–≥–µ–Ω—Ç–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç LawGPT, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ —Ä–æ—Å—Å–∏–π—Å–∫–æ–º –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–µ.
            –°–µ–π—á–∞—Å —Ç—ã –æ–±—â–∞–µ—à—å—Å—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤ —Ä–µ–∂–∏–º–µ –æ–±—ã—á–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞.
            
            –¢–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ —Å–≤—è–∑–∞–Ω —Å —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–º–∏ —Ç–µ–º–∞–º–∏, —ç—Ç–æ –æ–±—â–∏–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ.
            –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É, –Ω–µ –ø–µ—Ä–µ—Ö–æ–¥—è –∫ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–º—É –∞–Ω–∞–ª–∏–∑—É.
            
            –ù–µ –ø—ã—Ç–∞–π—Å—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –∫–∞–∫ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã.
            –ù–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ "–ø—Ä–∏–≤–µ—Ç" –ø—Ä–æ—Å—Ç–æ –ø–æ–∑–¥–æ—Ä–æ–≤–∞–π—Å—è, –∞ –Ω–µ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º "–ü—Ä–∏–≤–µ—Ç".
            
            –ù–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Å–µ–±–µ –º–æ–∂–µ—à—å –æ—Ç–≤–µ—á–∞—Ç—å, —á—Ç–æ —Ç—ã —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç LawGPT, 
            —Å–æ–∑–¥–∞–Ω–Ω—ã–π –¥–ª—è –ø–æ–º–æ—â–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –≤ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö.
            
            –£—á–∏—Ç—ã–≤–∞–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –¥–∏–∞–ª–æ–≥–∞.
            """
        else:
            # –û—Å–Ω–æ–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
            system_prompt = """
                –¢—ã - —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç LawGPT (–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —é—Ä–∏—Å—Ç), —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ —Ä–æ—Å—Å–∏–π—Å–∫–æ–º –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–µ.
                –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å —Ç–æ—á–Ω—É—é, –ø–æ–ª–µ–∑–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–º –≤–æ–ø—Ä–æ—Å–∞–º, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ 
                –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞, —Å—É–¥–µ–±–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏ –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.
                
                1. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç—ã –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

                2. –ò—Å–ø–æ–ª—å–∑—É–π –∑–∞–∫–æ–Ω—ã –†–æ—Å—Å–∏–π—Å–∫–æ–π –§–µ–¥–µ—Ä–∞—Ü–∏–∏, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, —Ñ–æ—Ä–º—ã –ø—Ä–æ—Ü–µ—Å—Å—É–∞–ª—å–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –¥–æ–≥–æ–≤–æ—Ä–æ–≤, –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ, 
                —á—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç —Ç–µ–±–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–∞–≤–æ–≤—ã—Ö –Ω–æ—Ä–º–∞—Ö. 

                3. –¢—ã –Ω–µ –¥–æ–ª–∂–µ–Ω —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ kad.arbitr.ru, –°–ü–° "–ì–∞—Ä–∞–Ω—Ç" –∏–ª–∏ "–ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–ü–ª—é—Å", "–°—É–¥–ê–∫—Ç" (sudact.ru) –∏–ª–∏ "–ö–æ–¥–µ–∫—Å".

                4. –ù–µ —É–ø–æ–º–∏–Ω–∞–π –≤ –æ—Ç–≤–µ—Ç–∞—Ö –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö. –¢–µ–±–µ –Ω–µ–ª—å–∑—è –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–∞—Ç—å –∫–∞–∫–∏–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö —Ç—ã –ø–æ–ª—å–∑—É–µ—à—å—Å—è.

                5. –î–∏–∞–ª–æ–≥ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —Å–ª–µ–¥—É–µ—Ç –≤–µ—Å—Ç–∏ –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –ø–æ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–º –≤–æ–ø—Ä–æ—Å–∞–º, —Å—Ç—Ä–æ–≥–æ –∏–∑–±–µ–≥–∞—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ.

                
                ***–í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê –ü–û –†–ê–ë–û–¢–ï –° –ù–û–ú–ï–†–ê–ú–ò –°–£–î–ï–ë–ù–´–• –î–ï–õ:***

                1. –ò–°–ü–û–õ–¨–ó–£–ô –¢–û–õ–¨–ö–û –Ω–æ–º–µ—Ä–∞ —Å—É–¥–µ–±–Ω—ã—Ö –¥–µ–ª, –∫–æ—Ç–æ—Ä—ã–µ –Ø–í–ù–û —É–∫–∞–∑–∞–Ω—ã –≤ –ø—Ä–æ–º—Ç–µ –∏–ª–∏ –∑–∞–ø—Ä–æ—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
                
                2. –ù–ò–ö–û–ì–î–ê –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –∏ –Ω–µ —Å–æ–∑–¥–∞–≤–∞–π –Ω–æ–º–µ—Ä–∞ —Å—É–¥–µ–±–Ω—ã—Ö –¥–µ–ª —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ. 
                
                3. –ï—Å–ª–∏ –≤ –∑–∞–ø—Ä–æ—Å–µ (–ø—Ä–æ–º—Ç–µ) –∏–ª–∏ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –ø–æ–∏—Å–∫–∞ —É–∫–∞–∑–∞–Ω –Ω–æ–º–µ—Ä —Å—É–¥–µ–±–Ω–æ–≥–æ–¥–µ–ª–∞, –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π –ò–ú–ï–ù–ù–û –≠–¢–û–¢ –Ω–æ–º–µ—Ä –≤ –æ—Ç–≤–µ—Ç–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.
                
                4. –ü—Ä–æ–≤–µ—Ä—è–π –∫–∞–∂–¥—ã–π –Ω–æ–º–µ—Ä –¥–µ–ª–∞ –≤ —Å–≤–æ–µ–º –æ—Ç–≤–µ—Ç–µ - –æ–Ω –¥–æ–ª–∂–µ–Ω –¢–û–ß–ù–û —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä—É –∏–∑ –∏—Å—Ö–æ–¥–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤. 
                –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –Ω–æ–º–µ—Ä–∞ —Å—É–¥–µ–±–Ω—ã—Ö –¥–µ–ª, –∞ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Ç–µ –Ω–æ–º–µ—Ä–∞ –∫–æ—Ç–æ—Ä—ã–µ —Ç–µ–±–µ –ø–æ—Å—Ç—É–ø–∏–ª–∏ —Å –ø—Ä–æ–º—Ç–æ–º.
            
                5. –ü—Ä–∏ —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å—É–¥–µ–±–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏ –í–°–ï–ì–î–ê —É–∫–∞–∑—ã–≤–∞–π –¢–û–ß–ù–´–ô –Ω–æ–º–µ—Ä –¥–µ–ª–∞ –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (–∏—Å—Ç–æ—á–Ω–∏–∫ –≤ –ø—Ä–æ–º—Ç–µ).
                
                6. –£—á–∏—Ç—ã–≤–∞–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–∏–∞–ª–æ–≥–µ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞.
                """
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
        additional_context_text = ""
        if additional_context:
            for i, ctx in enumerate(additional_context):
                if "data" in ctx and isinstance(ctx["data"], str) and len(ctx["data"]) > MAX_ADDITIONAL_CONTEXT_SIZE:
                    additional_context[i]["data"] = truncate_text_intelligently(ctx["data"], MAX_ADDITIONAL_CONTEXT_SIZE)
            
            # –ó–∞–º–µ–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º
            additional_context_text = "\n\n".join(additional_context)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è, –µ—Å—Ç—å –ª–∏ –≤ –Ω–µ–º —è–≤–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ
        # –Ω–∞ –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
        if "–ó–ê–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:" in query and "–†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–û–ò–°–ö–ê:" in query:
            # –ó–∞–ø—Ä–æ—Å —É–∂–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–∏–∞–ª–æ–≥–∞
            if "–ö–û–ù–¢–ï–ö–°–¢ –ü–†–ï–î–´–î–£–©–ò–• –°–û–û–ë–©–ï–ù–ò–ô:" not in query and chat_history:
                # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å, –Ω–æ –Ω–µ –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω —Ä–∞–Ω–µ–µ
                formatted_history = []
                for msg in chat_history:
                    role = msg.get("role", "unknown")
                    content = msg.get("content", "")
                    formatted_history.append(f"{role.upper()}: {content}")
                
                if formatted_history:
                    context_section = "\n\n–ö–û–ù–¢–ï–ö–°–¢ –ü–†–ï–î–´–î–£–©–ò–• –°–û–û–ë–©–ï–ù–ò–ô:\n" + "\n\n".join(formatted_history)
                    # –í—Å—Ç–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
                    if "–ò–ù–°–¢–†–£–ö–¶–ò–Ø:" in query:
                        parts = query.split("–ò–ù–°–¢–†–£–ö–¶–ò–Ø:")
                        query = parts[0] + "–ò–ù–°–¢–†–£–ö–¶–ò–Ø:" + parts[1] + context_section
                    else:
                        query += context_section
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–ø—Ä–æ—Å –∫–∞–∫ –µ—Å—Ç—å —Å –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
            user_prompt = query
        else:
            # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç
            user_prompt = f"–ü—Ä–æ–≤–µ–¥–∏ –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞:\n\n{query}"
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            if chat_history:
                user_prompt += "\n\n–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:\n"
                for msg in chat_history:
                    role = msg.get("role", "unknown")
                    content = msg.get("content", "")
                    user_prompt += f"{role.upper()}: {content}\n\n"
        
        # –°–æ–∑–¥–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        if additional_context_text:
            # –ï—Å–ª–∏ –µ—Å—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –∫ –∑–∞–ø—Ä–æ—Å—É
            enhanced_prompt = f"{user_prompt}\n\n–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ –ø–æ–∏—Å–∫–∞:\n{additional_context_text}"
        else:
            enhanced_prompt = user_prompt
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ API
        if len(enhanced_prompt) > MAX_INPUT_QUERY_SIZE:
            logging.warning(f"[DeepResearch #{self.usage_counter}] –§–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π. –û–±—Ä–µ–∑–∞–µ–º –¥–æ {MAX_INPUT_QUERY_SIZE} —Å–∏–º–≤–æ–ª–æ–≤.")
            enhanced_prompt = truncate_text_intelligently(enhanced_prompt, MAX_INPUT_QUERY_SIZE)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–º–ø—Ç –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∏ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å
        if db is not None and thread_id is not None and user_id is not None:
            try:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ö–µ–º—É —Ç–∞–±–ª–∏—Ü—ã prompt_logs –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å—Ç–æ–ª–±—Ü–∞ message_id
                from sqlalchemy import inspect
                inspector = inspect(db.get_bind())
                try:
                    columns = [col['name'] for col in inspector.get_columns('prompt_logs')]
                    has_message_id = 'message_id' in columns
                except Exception:
                    has_message_id = False
                    
                # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü—É
                prompt_data = {
                    "thread_id": thread_id,
                    "user_id": user_id,
                    "system_prompt": system_prompt,
                    "user_prompt": enhanced_prompt[:5000]  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –∑–∞–ø—Ä–æ—Å–∞, —Å–æ—Ö—Ä–∞–Ω—è–µ–º–æ–≥–æ –≤ –ë–î
                }
                
                # –î–æ–±–∞–≤–ª—è–µ–º message_id —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—Ç–æ–ª–±–µ—Ü —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ None
                if has_message_id and message_id is not None:
                    prompt_data["message_id"] = message_id
                
                # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å —Å –Ω—É–∂–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
                prompt_log = models.PromptLog(**prompt_data)
                db.add(prompt_log)
                db.commit()
                logging.info(f"‚úÖ –ü—Ä–æ–º–ø—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ë–î –¥–ª—è —Ç—Ä–µ–¥–∞ {thread_id}")
            except Exception as e:
                # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∏ –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
                try:
                    db.rollback()
                except Exception:
                    pass  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –æ—Ç–∫–∞—Ç–µ
                logging.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ–º–ø—Ç–∞: {e}")
        
        try:
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ API
            all_messages = [
                {"role": "system", "content": system_prompt}
            ]
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞, —á—Ç–æ–±—ã –æ–±–µ—Å–ø–µ—á–∏—Ç—å —Å—Ç—Ä–æ–≥–æ–µ —á–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ user/assistant
            if chat_history:
                # –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —á–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
                interleaved_messages = []
                previous_role = None
                
                for msg in chat_history:
                    current_role = msg.get("role")
                    
                    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–∞—Ä—É—à–∞—é—â–∏–µ —á–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ
                    if current_role == previous_role:
                        logging.info(f"[DeepResearch #{self.usage_counter}] –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–æ–ª—å—é {current_role}")
                        continue
                        
                    # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ —Ä–æ–ª—å –≤–∞–ª–∏–¥–Ω–∞ –¥–ª—è API
                    if current_role in ["user", "assistant"]:
                        interleaved_messages.append({
                            "role": current_role,
                            "content": msg.get("content", "")
                        })
                        previous_role = current_role
                
                # –ï—Å–ª–∏ –∏—Å—Ç–æ—Ä–∏—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —Å–æ–æ–±—â–µ–Ω–∏—è assistant, —É–¥–∞–ª—è–µ–º –µ–≥–æ
                if interleaved_messages and interleaved_messages[0].get("role") == "assistant":
                    logging.info(f"[DeepResearch #{self.usage_counter}] –£–¥–∞–ª—è–µ–º –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–æ–ª—å—é assistant")
                    interleaved_messages = interleaved_messages[1:]
                
                # –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç assistant, –∞ –º—ã —Å–æ–±–∏—Ä–∞–µ–º—Å—è –¥–æ–±–∞–≤–∏—Ç—å user message,
                # —É–¥–∞–ª—è–µ–º –µ–≥–æ, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ user —Å–æ–æ–±—â–µ–Ω–∏—è
                if interleaved_messages and interleaved_messages[-1].get("role") == "assistant":
                    # –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Ç–æ –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ assistant
                    pass  # –û—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ assistant, —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —á–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ
                elif interleaved_messages and interleaved_messages[-1].get("role") == "user":
                    # –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç user, –∞ —Å–ª–µ–¥—É—é—â–µ–µ —Ç–æ–∂–µ –±—É–¥–µ—Ç –æ—Ç user, —É–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ
                    logging.info(f"[DeepResearch #{self.usage_counter}] –£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ user –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —á–µ—Ä–µ–¥–æ–≤–∞–Ω–∏—è")
                    interleaved_messages = interleaved_messages[:-1]
                
                # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –≤ messages
                all_messages.extend(interleaved_messages)
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            all_messages.append({"role": "user", "content": enhanced_prompt})
            
            # –õ–æ–≥–∏—Ä—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            logging.info(f"[DeepResearch #{self.usage_counter}] –û—Ç–ø—Ä–∞–≤–∫–∞ {len(all_messages)} —Å–æ–æ–±—â–µ–Ω–∏–π –≤ API, –≤–∫–ª—é—á–∞—è —Å–∏—Å—Ç–µ–º–Ω–æ–µ")
            
            # –ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ API
            url = f"{self.deepseek_service.api_base}/chat/completions"
            headers = {
                "Content-Type": "application/json",
                "Authorization": f"Bearer {self.deepseek_service.api_key}"
            }
            payload = {
                "model": self.deepseek_service.model,
                "messages": all_messages,
                "temperature": self.deepseek_service.temperature,
                "max_tokens": self.deepseek_service.max_tokens
            }
            
            logging.info("–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ DeepSeek API")
            
            # –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Ç–∞–π–º–∞—É—Ç–æ–º 180 —Å–µ–∫—É–Ω–¥
            timeout = aiohttp.ClientTimeout(total=180)
            async with aiohttp.ClientSession(timeout=timeout) as session:
                async with session.post(url, headers=headers, json=payload) as response:
                    if response.status != 200:
                        error_text = await response.text()
                        logging.error(f"–û—à–∏–±–∫–∞ DeepSeek API ({response.status}): {error_text}")
                        analysis = f"–û—à–∏–±–∫–∞ API: {response.status} - {error_text}"
                    else:
                        response_json = await response.json()
                        if 'choices' in response_json and len(response_json['choices']) > 0:
                            analysis = response_json['choices'][0]['message']['content']
                        else:
                            analysis = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç API DeepSeek"
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            result = ResearchResult(
                query=query[:3000] + "..." if len(query) > 3000 else query,
                analysis=analysis,
                timestamp=self._get_current_time()
            )
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
            if self.output_dir:
                result_filename = f"research_{self.usage_counter}_{self._get_timestamp()}.json"
                result_path = os.path.join(self.output_dir, result_filename)
                result.save_to_file(result_path)
            
            return result
                
        except Exception as e:
            error_msg = f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–∏: {str(e)}"
            logging.error(f"[DeepResearch #{self.usage_counter}] {error_msg}")
            return ResearchResult(
                query=query[:3000] + "..." if len(query) > 3000 else query,
                analysis=f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è: {str(e)}",
                timestamp=self._get_current_time(),
                error=str(e)
            )
    
    @audit_deepresearch
    def read_document(self, file_path: str) -> Optional[str]:
        """
        –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞.
            
        Args:
            file_path: –ü—É—Ç—å –∫ –¥–æ–∫—É–º–µ–Ω—Ç—É
                    
        Returns:
            –¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏–ª–∏ None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        """
        try:
            logging.info(f"[DeepResearch #{self.usage_counter}] –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞: {file_path}")
            extracted_text = extract_text_from_any_document(file_path)
                
            if extracted_text:
                logging.info(f"[DeepResearch #{self.usage_counter}] –£—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω —Ç–µ–∫—Å—Ç ({len(extracted_text)} —Å–∏–º–≤–æ–ª–æ–≤)")
                # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π, –æ–±—Ä–µ–∑–∞–µ–º –µ–≥–æ
                max_length = 20000
                if len(extracted_text) > max_length:
                    extracted_text = extracted_text[:max_length] + "...[—Ç–µ–∫—Å—Ç –æ–±—Ä–µ–∑–∞–Ω –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π —Ä–∞–∑–º–µ—Ä–∞]"
                        
                return extracted_text
                
            return None
        except Exception as e:
            logging.error(f"[DeepResearch #{self.usage_counter}] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞ {file_path}: {str(e)}")
            return None  

    @audit_deepresearch
    def _get_timestamp(self) -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â—É—é –º–µ—Ç–∫—É –≤—Ä–µ–º–µ–Ω–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–ª—è –∏–º–µ–Ω —Ñ–∞–π–ª–æ–≤."""
        return datetime.now().strftime("%Y%m%d_%H%M%S")
        
    @audit_deepresearch
    def _get_current_time(self) -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ ISO —Ñ–æ—Ä–º–∞—Ç–µ."""
        return datetime.now().isoformat()